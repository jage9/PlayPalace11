name: Build Installers

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "client/**"
      - "server/**"
      - "installer/**"
      - ".github/workflows/installers.yml"

jobs:
  linux-packages:
    name: Linux Packaging Placeholders
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: python -m pip install --upgrade uv

      - name: Install packaging toolchains and wxPython build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev rpm rpm2cpio rsync \
            libgtk-3-dev libsdl2-dev libnotify-dev libsm-dev \
            libgstreamer-gl1.0-0 freeglut3-dev pkg-config

      - name: Sync client dependencies
        run: |
          cd client
          echo 'setuptools<75' > /tmp/build-constraints.txt
          UV_BUILD_CONSTRAINT=/tmp/build-constraints.txt uv sync

      - name: Sync server dependencies
        run: |
          cd server
          uv sync

      - name: Build Debian packages
        run: |
          ./installer/linux/scripts/build_deb.sh

      - name: Upload Debian packages
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: installer/dist/linux/deb

      - name: Build RPM packages
        run: |
          ./installer/linux/scripts/build_rpm.sh

      - name: Upload RPM packages
        uses: actions/upload-artifact@v4
        with:
          name: linux-rpm
          path: installer/dist/linux/rpm

      - name: Test Debian packages (podman)
        env:
          PLAYPALACE_SIGNING_KEY_ID: ${{ secrets.PLAYPALACE_SIGNING_KEY_ID }}
        run: |
          ./installer/linux/scripts/test_deb.sh

      - name: Test RPM packages (podman)
        env:
          PLAYPALACE_SIGNING_KEY_ID: ${{ secrets.PLAYPALACE_SIGNING_KEY_ID }}
        run: |
          ./installer/linux/scripts/test_rpm.sh

  arch-packages:
    name: Arch Packages
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
    steps:
      - name: Install dependencies
        run: pacman -Syu --noconfirm git python python-pip rsync tar

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        run: pip install --upgrade uv --break-system-packages

      - name: Build Arch packages
        run: ./installer/linux/scripts/build_arch.sh

      - name: Test Arch packages
        run: ./installer/linux/scripts/test_arch.sh

      - name: Upload Arch packages
        uses: actions/upload-artifact@v4
        with:
          name: linux-arch
          path: installer/dist/linux/arch

  windows-msi:
    name: Windows MSI
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: python -m pip install --upgrade uv

      - name: Sync client dependencies
        shell: pwsh
        run: |
          Set-Location client
          uv sync

      - name: Build client executable
        shell: pwsh
        run: |
          Set-Location client
          ./build.ps1

      - name: Sync server dependencies
        shell: pwsh
        run: |
          Set-Location server
          uv sync

      - name: Build server executable
        shell: pwsh
        run: |
          Set-Location server
          ./build.ps1

      - name: Set up .NET for WiX
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install WiX v4 CLI
        shell: pwsh
        run: dotnet tool install --global wix --version 4.0.2

      - name: Build MSI with WiX
        shell: pwsh
        run: |
          $env:PATH += ";" + (Join-Path $env:USERPROFILE ".dotnet\tools")
          New-Item -ItemType Directory -Force -Path installer/dist | Out-Null
          Push-Location installer/windows/wix
          wix build PlayPalace.wxs -arch x64 -loc locales/en-us.wxl -out ../../dist/PlayPalace.msi
          Pop-Location

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: installer/dist/PlayPalace.msi
