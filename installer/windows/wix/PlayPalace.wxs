<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <!-- WiX v4 note on file Source paths (important for v3->v4 migrations):
       - Relative paths in `File/@Source` are resolved by the WiX binder using the *current working directory*
         of the `wix build` invocation (not the directory containing this .wxs).
       - `!(bindpath.<Id>)` values are also supplied to the binder (typically via `-bindpath`) and are robust
         regardless of CWD.

       Recommended (generalizable) fix:
         Use bind paths and pass them explicitly when building.

         If you run `wix build` from the repo root, the command should be:
           wix build installer\windows\wix\PlayPalace.wxs -arch x64 -loc installer\windows\wix\locales/en-us.wxl ^
             -bindpath ClientSource=client\dist\PlayPalace ^
             -bindpath ServerSource=server\dist ^
             -out installer\windows\dist\PlayPalace.msi

         If you run it from *any other* working directory, adjust the right-hand side paths accordingly
         (they are interpreted relative to the current working directory). Alternatively, use absolute paths. 

       This avoids fragile relative paths and fixes WIX0103 when the binder can't resolve sources. -->

  <Package Name="PlayPalace" Manufacturer="XGDevGroup" Version="11.0.0.0" UpgradeCode="{b40ba410-e0df-422a-9f26-f630a7fe3d1d}" Language="1033" Codepage="1252" Compressed="yes">
    <Icon Id="ProductIcon" SourceFile="installer\windows\wix\assets\product.ico" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <Property Id="SERVERHOST" Value="0.0.0.0" />
    <Property Id="SERVERPORT" Value="8000" />
    <Property Id="SERVERALLOWINSECURE" Value="0" />
    <Property Id="SERVERENABLESSL" Value="0" />
    <Property Id="SERVERCERTPATH" Secure="yes" />
    <Property Id="SERVERKEYPATH" Secure="yes" />
    <MajorUpgrade Schedule="afterInstallInitialize" AllowDowngrades="no" DowngradeErrorMessage="A newer version of PlayPalace is already installed." />

    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="PlayPalace">
        <Directory Id="CLIENTDIR" Name="Client" />
        <Directory Id="SERVERDIR" Name="Server" />
        <Directory Id="TOOLSDIR" Name="tools" />
      </Directory>
    </StandardDirectory>
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="PlayPalaceProgramMenu" Name="PlayPalace" />
    </StandardDirectory>
    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="CONFIGDIR" Name="PlayPalace" />
    </StandardDirectory>

    <Component Id="ClientExecutable" Directory="CLIENTDIR" Guid="{05b8b594-0a71-4e74-a32e-772842c64a63}">
      <File Id="PlayPalaceClientExe" Source="!(bindpath.ClientSource)\PlayPalace.exe" KeyPath="yes">
        <Shortcut Id="ClientStartMenuShortcut" Directory="PlayPalaceProgramMenu" Name="PlayPalace Client" WorkingDirectory="CLIENTDIR" Icon="ProductIcon" IconIndex="0" />
      </File>
    </Component>

    <Component Id="ServerExecutable" Directory="SERVERDIR" Guid="{9c0b7f68-4c76-4e3a-aa83-07c2c0cc8171}">
      <File Id="PlayPalaceServerExe" Source="!(bindpath.ServerSource)\PlayPalaceServer.exe" KeyPath="yes" />
      <ServiceInstall
          Id="PlayPalaceServiceInstall"
          Name="PlayPalaceServer"
          DisplayName="PlayPalace Server"
          Type="ownProcess"
          Start="auto"
          ErrorControl="normal"
          Description="Runs the PlayPalace multiplayer server backend."
          Account="LocalSystem"
          Arguments="--host [SERVERHOST] --port [SERVERPORT]">
        <ServiceDependency Id="W32Time" />
      </ServiceInstall>
      <ServiceControl Id="PlayPalaceServiceControl" Name="PlayPalaceServer" Stop="both" Remove="uninstall" Wait="yes" />
    </Component>

    <Component Id="ProgramDataFolderComponent" Directory="CONFIGDIR" Guid="{9f8b8d5d-64d7-4f67-a921-bcd5634b9619}">
      <CreateFolder />
    </Component>

    <Component Id="ConfigureScriptComponent" Directory="TOOLSDIR" Guid="{3cc85d8a-3ab2-4e13-93b6-5530f99c12f7}">
      <File Id="ConfigureServerScript" Source="installer\windows\configure_server.ps1" KeyPath="yes" />
    </Component>

    <Component Id="SelfSignedScriptComponent" Directory="TOOLSDIR" Guid="{5586b47e-564f-47fb-9620-418a564a9104}">
      <File Id="GenerateCertScript" Source="installer\windows\generate_self_signed.ps1" KeyPath="yes" />
    </Component>

    <ComponentGroup Id="ClientComponents">
      <ComponentRef Id="ClientExecutable" />
    </ComponentGroup>

    <ComponentGroup Id="ServerComponents">
      <ComponentRef Id="ServerExecutable" />
      <ComponentRef Id="ProgramDataFolderComponent" />
    </ComponentGroup>

    <ComponentGroup Id="InstallerToolsComponents">
      <ComponentRef Id="ConfigureScriptComponent" />
      <ComponentRef Id="SelfSignedScriptComponent" />
    </ComponentGroup>

    <Feature Id="ClientFeature" Title="!(loc.FeatureClient)" Level="1" AllowAbsent="yes" ConfigurableDirectory="CLIENTDIR">
      <ComponentGroupRef Id="ClientComponents" />
    </Feature>

    <Feature Id="ServerFeature" Title="!(loc.FeatureServer)" Level="1" AllowAbsent="yes" ConfigurableDirectory="SERVERDIR">
      <ComponentGroupRef Id="ServerComponents" />
      <ComponentGroupRef Id="InstallerToolsComponents" />
    </Feature>

    <CustomAction Id="ConfigureServerAction"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no"
                  Directory="TOOLSDIR"
                  ExeCommand="&quot;powershell.exe&quot; -ExecutionPolicy Bypass -NoProfile -File &quot;[#ConfigureServerScript]&quot; -ProgramDataPath &quot;[CommonAppDataFolder]PlayPalace&quot; -HostName &quot;[SERVERHOST]&quot; -Port &quot;[SERVERPORT]&quot; -AllowInsecure [SERVERALLOWINSECURE] -EnableSsl [SERVERENABLESSL] -CertificatePath &quot;[SERVERCERTPATH]&quot; -PrivateKeyPath &quot;[SERVERKEYPATH]&quot;" />

    <InstallExecuteSequence>
      <Custom Action="ConfigureServerAction" After="InstallFiles" Condition="(&amp;ServerFeature=3) AND (!ServerFeature=2)" />
    </InstallExecuteSequence>


    <CustomAction Id="ValidateCertAction"
                  Execute="immediate"
                  Return="check"
                  Impersonate="yes"
                  Directory="TOOLSDIR"
                  ExeCommand="&quot;powershell.exe&quot; -ExecutionPolicy Bypass -NoProfile -Command &quot;&amp; { if (-not &quot;[SERVERCERTPATH]&quot;) { throw &quot;Certificate path missing&quot; } if (-not (Test-Path &quot;[SERVERCERTPATH]&quot;)) { throw &quot;Certificate path not found&quot; } if (-not &quot;[SERVERKEYPATH]&quot;) { throw &quot;Key path missing&quot; } if (-not (Test-Path &quot;[SERVERKEYPATH]&quot;)) { throw &quot;Key path not found&quot; } Write-Output &quot;Certificate inputs look valid.&quot; }&quot;" />

    <CustomAction Id="GenerateCertAction"
                  Execute="immediate"
                  Return="check"
                  Impersonate="no"
                  Directory="TOOLSDIR"
                  ExeCommand="&quot;powershell.exe&quot; -ExecutionPolicy Bypass -NoProfile -File &quot;[#GenerateCertScript]&quot; -OutDir &quot;[CommonAppDataFolder]PlayPalace\ssl&quot;" />

    <UI>
      <TextStyle Id="Tahoma" FaceName="Tahoma" Size="8" />
      <Dialog Id="WelcomeDlg" Width="370" Height="270" Title="PlayPalace Setup">
        <Control Id="Title" Type="Text" X="15" Y="6" Width="340" Height="15" Transparent="yes" NoPrefix="yes" Text="PlayPalace Setup" />
        <Control Id="Description" Type="Text" X="15" Y="23" Width="340" Height="30" Text="Welcome to the PlayPalace installer." />
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="Next">
          <Publish Event="NewDialog" Value="ServerConfigDlg" />
        </Control>
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel">
          <Publish Event="EndDialog" Value="Exit" />
        </Control>
      </Dialog>

      <Dialog Id="ServerConfigDlg" Width="370" Height="295" Title="!(loc.ConfigDialogTitle)">
        <Control Id="Title" Type="Text" X="15" Y="6" Width="340" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.ConfigDialogTitle)" />
        <Control Id="Description" Type="Text" X="15" Y="23" Width="340" Height="30" Text="!(loc.ConfigDialogDescription)" />

        <Control Id="HostLabel" Type="Text" X="15" Y="60" Width="140" Height="10" Text="!(loc.ConfigHostLabel)" />
        <Control Id="HostEdit" Type="Edit" X="15" Y="72" Width="160" Height="18" Property="SERVERHOST" />

        <Control Id="PortLabel" Type="Text" X="190" Y="60" Width="60" Height="10" Text="!(loc.ConfigPortLabel)" />
        <Control Id="PortEdit" Type="Edit" X="190" Y="72" Width="70" Height="18" Property="SERVERPORT" />

        <Control Id="AllowInsecureCheck" Type="CheckBox" X="15" Y="100" Width="330" Height="16" Property="SERVERALLOWINSECURE" CheckBoxValue="1" Text="!(loc.ConfigAllowInsecure)" />

        <Control Id="EnableSslCheck" Type="CheckBox" X="15" Y="122" Width="330" Height="16" Property="SERVERENABLESSL" CheckBoxValue="1" Text="!(loc.ConfigEnableSsl)" />

        <Control Id="CertLabel" Type="Text" X="15" Y="145" Width="330" Height="10" Text="!(loc.ConfigCertPath)" />
        <Control Id="CertPath" Type="PathEdit" X="15" Y="157" Width="330" Height="18" Property="SERVERCERTPATH" />

        <Control Id="KeyLabel" Type="Text" X="15" Y="180" Width="330" Height="10" Text="!(loc.ConfigKeyPath)" />
        <Control Id="KeyPath" Type="PathEdit" X="15" Y="192" Width="330" Height="18" Property="SERVERKEYPATH" />

        <Control Id="GenerateCertBtn" Type="PushButton" X="15" Y="217" Width="160" Height="17" Text="!(loc.ConfigGenerateCert)" />
        <Control Id="ValidateCertBtn" Type="PushButton" X="185" Y="217" Width="160" Height="17" Text="!(loc.ConfigValidateCert)" />

        <Control Id="Back" Type="PushButton" X="150" Y="268" Width="56" Height="17" Text="Back">
          <Publish Event="EndDialog" Value="Return" />
        </Control>
        <Control Id="Next" Type="PushButton" X="222" Y="268" Width="56" Height="17" Default="yes" Text="Next">
          <Publish Event="EndDialog" Value="Return" />
        </Control>
        <Control Id="Cancel" Type="PushButton" X="294" Y="268" Width="56" Height="17" Cancel="yes" Text="Cancel">
          <Publish Event="EndDialog" Value="Return" />
        </Control>
      </Dialog>

    </UI>

    <WixVariable Id="WixUILicenseRtf" Value="LICENSE_PLACEHOLDER.rtf" />
    <WixVariable Id="WixUIBannerBmp" Value="installer\windows\wix\assets\banner.png" />
    <WixVariable Id="WixUIDialogBmp" Value="installer\windows\wix\assets\dialog.png" />
  </Package>
</Wix>
